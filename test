sudo apt update
sudo apt install -y libreoffice libreoffice-calc libreoffice-common \
                    python3-venv
# 日本語表示用フォント（推奨）
sudo apt install -y fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho \
                    fonts-noto-color-emoji

# サンプル: uploads/売上.xlsx を用意してから
libreoffice --headless --convert-to pdf --outdir ./out ./uploads/売上.xlsx
# → ./out/売上.pdf ができればOK


# 既存の import 群に追加
from flask import url_for

# 一覧ページのテンプレ（/）
INDEX_HTML = """
<!doctype html><meta charset="utf-8">
<title>Excel 一覧</title>
<style>
  body{font-family:system-ui;margin:24px}
  h1{font-size:20px;margin:0 0 12px}
  ul{padding-left:18px}
  li{margin:4px 0}
  .empty{color:#666}
  code{background:#f5f5f5;padding:2px 6px;border-radius:4px}
</style>
<h1>Excel 一覧（{{ files|length }} 件）</h1>
{% if files %}
  <ul>
  {% for f in files %}
    <li>
      <a href="{{ url_for('view_excel', filename=f) }}">{{ f }}</a>
      <small>（PDF表示）</small>
    </li>
  {% endfor %}
  </ul>
{% else %}
  <p class="empty">uploads/ に .xlsx / .xlsm / .xls を置くと一覧に出ます。</p>
{% endif %}
<p>直接アクセス例：<code>/view/売上.xlsx</code> や <code>/excel-pdf/売上.xlsx</code></p>
"""

def _iter_excels():
    """uploads/ 配下の Excel を相対パス（POSIX）で列挙"""
    exts = {".xlsx", ".xlsm", ".xls"}
    if not UPLOAD_DIR.exists():
        return []
    files = []
    for p in UPLOAD_DIR.rglob("*"):
        if p.is_file() and p.suffix.lower() in exts:
            files.append(p.relative_to(UPLOAD_DIR).as_posix())
    return sorted(files)

@app.route("/")
def index():
    files = _iter_excels()
    return render_template_string(INDEX_HTML, files=files)


